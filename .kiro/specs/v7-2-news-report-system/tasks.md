# Implementation Plan

## Overview

このタスクリストは、V7.2ニュースレポート自動生成システムの実装を段階的に進めるためのものです。各タスクは、要件定義書とデザイン設計書に基づいて作成されています。

## Tasks

- [ ] 1. プロジェクト構造とユーティリティの実装
  - プロジェクトの基本構造を作成し、共通ユーティリティを実装します
  - _Requirements: 10.1, 10.2_

- [ ] 1.1 プロジェクト構造の作成
  - ディレクトリ構造を作成（`src/`, `tests/`, `output/`）
  - `requirements.txt` を作成し、必要なパッケージを記載
  - `.env.example` を作成し、必要な環境変数のテンプレートを提供
  - _Requirements: 10.1_

- [ ] 1.2 実行ログ記録クラスの実装
  - `ExecutionLogger` クラスを実装
  - タイムスタンプ付きログ記録機能
  - ログファイル保存機能
  - テストを作成して動作を確認
  - _Requirements: 9.3, 9.4_

- [ ] 1.3 環境変数検証ユーティリティの実装
  - 環境変数の読み込みと検証機能を実装
  - 必須環境変数のチェック（LLM API キー、NewsAPI キー、Slack トークン）
  - エラーメッセージの表示
  - テストを作成して動作を確認
  - _Requirements: 10.1, 10.2_

- [ ] 2. データ収集コンポーネントの実装
  - 株価データとニュースデータを収集するコンポーネントを実装します
  - _Requirements: 2.1, 2.2, 2.3, 2.4, 3.1, 3.2, 3.3, 3.4, 3.5, 3.6_

- [ ] 2.1 株価データ収集機能の実装
  - `fetch_stock_prices()` 関数を実装
  - yfinance を使用して主要4指数のデータを取得
  - エラーハンドリング（個別指数の取得失敗時も続行）
  - テストを作成（yfinance のモック）
  - _Requirements: 2.1, 2.2, 2.3, 2.4_

- [ ] 2.2 NewsAPI データ収集機能の実装
  - `fetch_newsapi_news()` 関数を実装
  - `/top-headlines` エンドポイントを使用
  - 日米両方のBloomberg、WSJ、Reutersからデータ取得
  - エラーハンドリング（取得失敗時は警告を記録）
  - テストを作成（NewsAPI のモック）
  - _Requirements: 3.1, 3.2, 3.4_

- [ ] 2.3 Investing.com RSS データ収集機能の実装
  - `fetch_investing_com_news()` 関数を実装
  - 複数のRSSフィードから過去24時間のニュースを取得
  - 重複削除機能
  - エラーハンドリング（取得失敗時は警告を記録）
  - テストを作成（feedparser のモック）
  - _Requirements: 3.1, 3.3, 3.5, 3.6_

- [ ] 3. LLM サービスの実装
  - マルチプロバイダー対応のLLMサービスを実装します
  - _Requirements: 4.1, 4.2_

- [ ] 3.1 LLM Service 基底クラスの実装
  - `LLMService` クラスを実装
  - プロバイダー選択ロジック（Gemini → GPT → Claude）
  - 統一インターフェース（`generate()`, `generate_json()`）
  - テストを作成（環境変数のモック）
  - _Requirements: 4.1, 4.2_

- [ ] 3.2 Gemini プロバイダーの実装
  - `GeminiProvider` クラスを実装
  - `google-generativeai` ライブラリを使用
  - テキスト生成とJSON生成機能
  - エラーハンドリング
  - テストを作成（Gemini API のモック）
  - _Requirements: 4.1_

- [ ] 3.3 GPT プロバイダーの実装
  - `GPTProvider` クラスを実装
  - `openai` ライブラリを使用
  - テキスト生成とJSON生成機能
  - エラーハンドリング
  - テストを作成（OpenAI API のモック）
  - _Requirements: 4.1_

- [ ] 3.4 Claude プロバイダーの実装
  - `ClaudeProvider` クラスを実装
  - `anthropic` ライブラリを使用
  - テキスト生成とJSON生成機能
  - エラーハンドリング
  - テストを作成（Anthropic API のモック）
  - _Requirements: 4.1_

- [ ] 3.5 LLM フォールバック機能の実装
  - プロバイダー間のフォールバック機能を実装
  - API エラー発生時に次のプロバイダーに切り替え
  - すべてのプロバイダーが失敗した場合のエラーハンドリング
  - テストを作成（複数プロバイダーのエラーシミュレーション）
  - _Requirements: 4.2_

- [ ] 4. レポート生成コンポーネントの実装
  - 初期ニュース生成、深堀り分析、レポート組み立てを実装します
  - _Requirements: 4.3, 4.4, 4.5, 5.1, 5.2, 5.3, 5.4, 5.5, 6.1, 6.2, 6.3, 6.4_

- [ ] 4.1 初期ニュース生成機能の実装
  - `generate_main_news_with_llm()` 関数を実装
  - LLM に直近12時間以内の15件のニュースを生成させる
  - セクター別・地域別・ソース別配分を指定
  - JSON形式でのレスポンス解析
  - 生成数不足時の警告処理
  - テストを作成（LLM レスポンスのモック）
  - _Requirements: 4.3, 4.4, 4.5_

- [ ] 4.2 深堀り分析機能の実装
  - `deep_dive_with_supplementary_data()` 関数を実装
  - 初期ニュース、補助データ、株価データを LLM に提供
  - 実際の URL のみを使用する指示
  - V7.1 形式の詳細分析を生成
  - JSON形式でのレスポンス解析
  - テストを作成（LLM レスポンスのモック）
  - _Requirements: 5.1, 5.2, 5.3_

- [ ] 4.3 URL 検証機能の実装
  - `validate_urls()` 関数を実装
  - 許可ドメイン（investing.com, bloomberg.com, wsj.com, reuters.com）のチェック
  - 架空 URL の検出と削除
  - 警告ログの記録
  - テストを作成（様々な URL パターン）
  - _Requirements: 5.4, 5.5_

- [ ] 4.4 市場動向分析生成機能の実装
  - `generate_market_overview_analysis()` 関数を実装
  - 株価データを基に LLM が市場分析を生成
  - 米国市場と日本市場の分析テキスト
  - テストを作成（LLM レスポンスのモック）
  - _Requirements: 6.2_

- [ ] 4.5 レポート組み立て機能の実装
  - `generate_v7_1_format_report()` 関数を実装
  - Markdown 形式のレポートを組み立て
  - 市場動向分析と個別ニュースを統合
  - サンプルに合わせた構造（第1章、第2章、総括）
  - ニュース概要や影響分析に補助データの URL を配置
  - テストを作成（レポート構造の検証）
  - _Requirements: 6.1, 6.3, 6.4_

- [ ] 5. 動画コンテンツ生成コンポーネントの実装
  - レポートから字幕、台本、素材リンクを生成します
  - _Requirements: 7.1, 7.2, 7.3, 7.4, 7.5_

- [ ] 5.1 字幕生成機能の実装
  - `generate_video_subtitles()` 関数を実装
  - レポート内容を「です・ます」調に変換
  - 1行あたり適切な長さに分割
  - 具体的な数字を保持
  - LLM を使用して自然な日本語に変換
  - テストを作成（LLM レスポンスのモック）
  - _Requirements: 7.2_

- [ ] 5.2 台本生成機能の実装
  - `generate_video_script()` 関数を実装
  - オープニング、市場動向、個別ニュース、クロージングを含む
  - 読み上げに適した形式
  - LLM を使用して台本を生成
  - テストを作成（LLM レスポンスのモック）
  - _Requirements: 7.3_

- [ ] 5.3 素材リンク生成機能の実装
  - `generate_image_links()` 関数を実装
  - 各ニュースの URL を抽出
  - Markdown リスト形式で出力
  - テストを作成（URL 抽出の検証）
  - _Requirements: 7.5_

- [ ] 5.4 動画コンテンツファイル出力機能の実装
  - 字幕、台本、素材リンクをファイルに保存
  - ファイル名規則に従う（`YYYYMMDD_動画用字幕.txt` など）
  - テストを作成（ファイル出力の検証）
  - _Requirements: 7.4_

- [ ] 6. ファイル管理コンポーネントの実装
  - ファイル保存と Slack アップロードを実装します
  - _Requirements: 8.1, 8.2, 8.3, 8.4, 8.5_

- [ ] 6.1 ファイル保存機能の実装
  - `save_files()` 関数を実装
  - レポート、ニュースデータ、実行ログ、動画コンテンツをローカルに保存
  - ファイル名規則に従う
  - エラーハンドリング（保存失敗時は警告）
  - テストを作成（ファイル I/O のモック）
  - _Requirements: 8.4_

- [ ] 6.2 Slack ファイルアップロード機能の実装
  - `upload_to_slack()` 関数を実装
  - `files_upload_v2` API を使用
  - 6つのファイルをスレッドにアップロード
  - 適切な説明コメントを添付
  - リトライ機能（最大3回）
  - エラーハンドリング
  - テストを作成（Slack API のモック）
  - _Requirements: 8.1, 8.2, 8.3_

- [ ] 7. Slack Bot ハンドラーの実装
  - Slack イベントの受信とレポート生成のトリガーを実装します
  - _Requirements: 1.1, 1.2, 1.3, 1.4, 1.5, 1.6_

- [ ] 7.1 Slack Bot 初期化の実装
  - `slack_bolt` を使用した Bot の初期化
  - Socket Mode の設定
  - 環境変数の読み込み
  - テストを作成（環境変数のモック）
  - _Requirements: 1.1_

- [ ] 7.2 メンションイベントハンドラーの実装
  - `handle_mention()` 関数を実装
  - 対象チャンネルのチェック
  - :eyes: スタンプで反応
  - 処理開始メッセージの投稿
  - テストを作成（Slack イベントのモック）
  - _Requirements: 1.1, 1.2, 1.6_

- [ ] 7.3 進捗状況投稿機能の実装
  - `post_progress()` 関数を実装
  - 各ステップの進捗をスレッドに投稿
  - 絵文字を使用した視覚的なフィードバック
  - テストを作成（Slack API のモック）
  - _Requirements: 1.3_

- [ ] 7.4 完了・エラー通知機能の実装
  - 完了時: :white_check_mark: スタンプと `@here` メンション付きメッセージ
  - エラー時: :x: スタンプとエラーメッセージ
  - テストを作成（Slack API のモック）
  - _Requirements: 1.4, 1.5_

- [ ] 8. オーケストレーターの実装
  - レポート生成プロセス全体を調整します
  - _Requirements: すべて_

- [ ] 8.1 メイン実行フローの実装
  - `main()` 関数を実装
  - 各ステップを順次実行
  - 実行ログの記録
  - エラーハンドリング
  - テストを作成（統合テスト）
  - _Requirements: すべて_

- [ ] 8.2 エラーハンドリング戦略の実装
  - `execute_with_error_handling()` 関数を実装
  - データソース取得失敗時の続行処理
  - LLM フォールバック
  - ファイル生成エラーの処理
  - Slack への通知
  - テストを作成（様々なエラーシナリオ）
  - _Requirements: 9.1, 9.2, 9.5_

- [ ] 8.3 Slack Bot とオーケストレーターの統合
  - Slack Bot からオーケストレーターを呼び出す
  - 進捗状況を Slack に投稿
  - ファイルを Slack にアップロード
  - テストを作成（E2E テスト）
  - _Requirements: すべて_

- [ ] 9. テストとドキュメントの整備
  - テストカバレッジを向上させ、ドキュメントを整備します
  - _Requirements: すべて_

- [ ] 9.1 ユニットテストの追加
  - すべてのコンポーネントのユニットテストを作成
  - モックを使用した外部 API のテスト
  - エッジケースのテスト
  - テストカバレッジ 80% 以上を目指す
  - _Requirements: すべて_

- [ ] 9.2 統合テストの作成
  - データ収集から レポート生成までの統合テスト
  - LLM フォールバックのテスト
  - エラーハンドリングのテスト
  - _Requirements: すべて_

- [ ] 9.3 README.md の作成
  - システム概要
  - セットアップ手順
  - 使用方法
  - トラブルシューティング
  - _Requirements: すべて_

- [ ] 9.4 API ドキュメントの作成
  - 各関数・クラスの docstring を追加
  - 型ヒントを追加
  - 使用例を追加
  - _Requirements: すべて_

- [ ] 10. デプロイと動作確認
  - システムをデプロイし、実際の環境で動作確認します
  - _Requirements: すべて_

- [ ] 10.1 環境構築手順の確認
  - `.env` ファイルの設定
  - 仮想環境のセットアップ
  - 依存パッケージのインストール
  - _Requirements: 10.1_

- [ ] 10.2 Slack Bot の起動と動作確認
  - Bot を起動
  - テストチャンネルでメンション
  - 各ステップの進捗確認
  - 生成されたファイルの確認
  - _Requirements: すべて_

- [ ] 10.3 本番環境での動作確認
  - 本番チャンネル（C09S2KBK3HU）での動作確認
  - レポートの品質確認
  - URL の検証
  - パフォーマンスの確認（実行時間）
  - _Requirements: すべて_

- [ ] 10.4 エラーシナリオの確認
  - データソース取得失敗時の動作
  - LLM API エラー時のフォールバック
  - ファイル生成エラー時の動作
  - Slack アップロード失敗時のリトライ
  - _Requirements: 9.1, 9.2, 9.5_
