# システム分析と改善提案

## 1. システムのコア機能

このシステム（V7.2 ニュースレポート自動生成システム）のコアとなる機能は以下の通りです。

1.  **Slack トリガーとインタラクション**:
    *   Slack メンション (`@news_bot`) をトリガーとして起動。
    *   進捗状況（:eyes:, :white_check_mark:, :x:）とメッセージをスレッドにリアルタイム投稿。
    *   最終的な成果物を Slack スレッドにアップロード。

2.  **マルチソースデータ収集**:
    *   **株価データ**: yfinance を使用して主要4指数（ダウ、ナスダック総合指数、S&P500、日経225）を取得。市場名は正確に表記（例：ナスダック→ナスダック総合指数）。
    *   **ニュースデータ**: NewsAPI.org (Bloomberg, WSJ, Reuters) のみから収集（Investing.com RSSは除外、もしくは補助データとして限定利用）。

3.  **LLM を活用した高度な分析と生成**:
    *   **初期ニュース生成**: 直近12時間の重要ニュースを抽出。ソースは Bloomberg, Reuters, WSJ に限定。
    *   **深堀り分析**: 事実ベースの情報を重視し、アナリストの意見や考察を除外。
    *   **文字数制限なし**: 要約と概要は文字数制限を設けず、詳細なデータと内容を記述。
    *   **URL 検証**: 実在する信頼できるドメイン（bloomberg.com, wsj.com, reuters.com）の URL のみを使用。

4.  **マルチフォーマット出力生成**:
    *   **Markdown レポート**: 市場動向と個別ニュースの詳細レポート。
    *   **動画用コンテンツ**: YouTube 動画作成用の「字幕」と「台本」（タイツ風キャラクター）。
    *   **素材リンク集**: 動画で使用する画像の URL リスト。

## 2. アウトプットで外してはいけない内容

`sample` フォルダ内の成果物および要件定義書に基づき、以下の要素は必須です。

### A. ニュースまとめ (Markdown)
*   **発行日**: 冒頭に明記。
*   **市場全体の動向**:
    *   米国・日本市場の主要指数の表（終値、前日比、変動率）。
    *   LLM による市場概況の分析テキスト。
*   **ピックアップニュース (15件以上)**:
    *   **企業情報**: 企業名、ティッカー、時価総額、セクター。
    *   **ニュース概要**: 詳細な概要と、文中に埋め込まれた**実際のソース URL**。
    *   **市場への影響（深堀り）**: プラス/マイナスの理由、懸念事項、影響を受けるセクター/銘柄、短期・長期の影響。
    *   **投資家への示唆**: 具体的なアクションや視点。
    *   **出典**: 記事の URL。
*   **総括**: 全体のまとめ。

### B. 動画用台本 & 字幕 (Text)
*   **キャラクター設定**: 「タイツ」というキャラクター（「皆さん、こんにちは。タイツです。」「タイツでした。」）。
*   **構成**:
    *   オープニング（挨拶、日付）。
    *   市場全体の動向。
    *   個別ニュース（タイトル、画像表示指示、概要、市場への影響）。
    *   クロージング。
*   **画像表示指示**: `[画像を表示: URL]` の形式で、各ニュースに対応する画像を指定。

### C. その他
*   **実行ログ**: トレース可能性のため必須。
*   **Slack へのファイルアップロード**: ユーザーがダウンロードしやすいように。

## 3. sampleのようなアウトプットを出力するための .kiro 内ファイルのアップデート

現状の `requirements.md` や `design.md` は概ね sample の構成をカバーしていますが、sample の「タイツ風」の具体的なトーンやフォーマットをより厳密に再現するために、以下の微調整が必要です。

### A. `design.md` / `prompts` の修正
*   **台本・字幕生成プロンプトの具体化**:
    *   **キャラクター指示**: 「タイツ」という一人称と語尾、決め台詞（「タイツでした。」）をプロンプトに明示的に組み込む。
    *   **画像指示フォーマット**: 台本内に `[画像を表示: URL]` という形式で画像リンクを挿入するよう LLM に指示するロジックを追加（現在は `generate_image_links` が別ファイル出力になっているが、台本内にも埋め込む必要があるかもしれません。sample では台本内に `[画像を表示: ...]` があります）。
    *   **字幕フォーマット**: `[字幕X]` というプレフィックスや `[画像X]` という行を含める形式（sampleの `20251119_動画用字幕_v7_2 2.txt` 参照）に合わせる。現在の設計では単なるテキスト行のリストになっている可能性があります。

### B. 重複排除ロジックの強化
*   Sample の末尾に `(重複)` として処理されているニュースがあります。
*   **ロジック追加**: 完全に除外するのではなく、sample のように「タイトルだけ出して重複と記載する」のか、それとも「完全にリストから消す」のかを明確にする必要があります。Sample ではリストには残しつつ「重複のため割愛」としているため、レポート生成時に重複チェックを行い、重複している場合は簡易表示にするロジックが必要です。

### C. URL 埋め込みの厳格化
*   ニュース概要の文中に `([Source Name](URL))` の形式でリンクを埋め込むことを、プロンプトでより強く強制する必要があります。
*   **出典の明記**: 記事の末尾や該当箇所に、必ず大元のニュースソース（Reuters, Bloomberg, WSJ）のURLを記載します。

### D. 新規要件への対応（チーム内討議内容）
*   **市場名の明確化**: 「ナスダック」などの曖昧な表現を避け、「ナスダック総合指数」など正式名称や具体的な指数名を指定するようプロンプトで指示。
*   **ソースの厳選**: ニュースソースを **Reuters, Bloomberg, WSJ** の3社に限定。Investing.com などは除外するか、これら3社の記事を転載している場合のみ利用するようフィルタリング。
*   **文字数制限の撤廃**: プロンプトから「100-200文字で」といった制約を削除し、「詳細に」「網羅的に」といった指示に変更。
*   **事実ベースの抽出**: プロンプトに「アナリストの意見、予測、個人的な見解を除外し、確定した事実、数値、発表内容のみを抽出せよ」という強力な制約を追加（System Prompt レベルで指示）。

## 4. よりよいシステムにするための提案

### A. 信頼性と精度の向上
1.  **ファクトチェック機能の強化**:
    *   LLM が生成した「数値」や「事実」を、収集した元記事のテキストと照らし合わせて検証するステップを追加（RAG 的なアプローチ）。
2.  **ソースの厳格化（多様化案は却下）**:
    *   **決定事項**: ニュースソースは **Reuters, Bloomberg, WSJ** の3社に限定します。Investing.com やその他のソースは品質担保のため使用しません。

### B. ユーザー体験 (UX) の向上
3.  **カスタマイズ可能なレポート**:
    *   Slack コマンドの引数で「注目セクター（例：Tech, Bio）」や「対象地域」を指定できるようにし、ユーザーの興味に合わせたニュースを優先的にピックアップする。
4.  **インタラクティブな深堀り**:
    *   レポート生成後、Slack スレッドで「このニュースについてもっと詳しく」と返信すると、追加の調査を行って回答する機能。

### C. 運用・保守性
5.  **テンプレートエンジン導入**:
    *   Markdown や台本の生成を LLM の生の出力に頼りすぎず、Jinja2 などのテンプレートエンジンを使用して、フォーマットの揺らぎ（見出しのレベルや表の形式など）を防止する。
6.  **自動アーカイブと検索**:
    *   生成したレポートを **Google Drive** に自動保存し、過去のレポートを検索・閲覧しやすくする機能を実装します。

### D. コンテンツの魅力向上（今回は見送り）
*   サムネイル自動生成や音声生成 (TTS) については、現段階では実装しません。
